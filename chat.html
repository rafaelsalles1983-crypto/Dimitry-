<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>—á–∞—Ç üåç</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --color-bg-light: #f5f5f5;
  --color-primary: #4CAF50;
  --color-primary-hover: #45a049;
  --color-chat-partner: #007BFF; /* azul para o nome do parceiro */
}

/* RESET */
* { box-sizing: border-box; margin:0; padding:0; }
html, body { height:100%; font-family:Arial,sans-serif; background: var(--color-bg-light); }

/* HEADER */
header { background:#fff; padding:10px; border-bottom:1px solid #ddd; z-index:100; display:flex; align-items:center; gap:8px; }
header h1 { display:flex; align-items:center; gap:8px; color: var(--color-primary); font-size:1.4em; }
.emoji-head { width:32px; height:32px; }

/* TOPBAR */
#topBar { display:flex; align-items:center; gap:8px; padding:6px 10px; background:#fafafa; border-bottom:1px solid #ddd; flex-wrap:wrap; overflow-x:auto; z-index:100; }
#topBar button { background:white; color:var(--color-primary); border:1px solid var(--color-primary); padding:6px 10px; border-radius:5px; cursor:pointer; flex-shrink:0; }
#topBar span { font-size:0.9em; flex-shrink:0; }

/* NOME DO PARCEIRO */
#chatPartnerName {
  position:absolute;
  top:8px;
  right:10px;
  font-size:0.95em;
  color: var(--color-chat-partner);
  font-weight:bold;
}

/* MOBILE USERS HORIZONTAL */
#mobileUserLine { display:none; overflow-x:hidden; white-space:nowrap; background:#fafafa; padding:6px 4px; border-bottom:1px solid #ddd; }
.userItemMobile { width:50px; height:50px; border-radius:50%; overflow:hidden; display:inline-block; margin-right:6px; border:2px solid transparent; cursor:pointer; transition: transform 0.2s; position:relative; }
.userItemMobile img { width:100%; height:100%; border-radius:50%; object-fit:cover; }
.userItemMobile:hover { border-color:var(--color-primary); transform:scale(1.1); }

/* ALERTA PISCANDO */
.alert-dot {
  position:absolute;
  top:0;
  right:0;
  width:12px;
  height:12px;
  background:red;
  border-radius:50%;
  animation: blink 1s infinite;
}
@keyframes blink { 50% { opacity:0; } }

/* MENU DE 3 PONTOS */
.menu-btn { position:absolute; top:4px; right:4px; width:18px; height:18px; cursor:pointer; }
.menu-btn div { width:4px; height:4px; background:#555; border-radius:50%; margin:2px 0; }

/* MAIN */
#mainContent { display:flex; flex:1; overflow:hidden; height: calc(100vh - 108px); position:relative; }

/* USER LIST (DESKTOP) */
#userList { width:200px; background:#fff; border-right:1px solid #ddd; overflow-y:auto; padding:8px; }
.userItem { display:flex; align-items:center; gap:6px; margin-bottom:6px; cursor:pointer; padding:6px; border-radius:5px; position:relative; }
.userItem:hover { background:#e0f7e9; }
.userItem img { width:28px; height:28px; border-radius:50%; }

/* CHAT */
#chatContainer { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
#chatWindow { flex:1; overflow-y:auto; padding:10px; background:white; margin-top:20px; }
.msg { margin:5px 0; padding:8px; border-radius:8px; max-width:80%; word-wrap:break-word; position:relative; }
.userMsg { background:#e0f7e9; align-self:flex-end; text-align:right; }
.otherMsg { background:#fff8dc; align-self:flex-start; text-align:left; }

/* CHAT INPUT */
#chatInput { display:flex; border-top:1px solid #ddd; background:white; padding:4px; }
#chatInput input { flex:1; padding:10px; font-size:1em; border:1px solid #ccc; border-radius:5px; }
#chatInput button { background:var(--color-primary); color:white; border:none; padding:10px 14px; margin-left:4px; border-radius:5px; cursor:pointer; }
#chatInput button:hover { background:var(--color-primary-hover); }

/* ADS */
#adSidebar { width:280px; background:#f1f1f1; border-left:1px dashed #ccc; padding:8px; text-align:center; overflow-y:auto; }

/* FOOTER */
footer { background:white; color:#555; text-align:center; padding:6px; font-size:0.85em; border-top:1px solid #ddd; }

/* MOBILE */
@media(max-width:768px){
  html, body { height:100%; overflow:visible; }
  header { position:fixed; top:0; left:0; right:0; z-index:100; height:50px; }
  #topBar { position:fixed; top:50px; left:0; right:0; z-index:100; width:100%; height:40px; }
  #mobileUserLine {
    display:flex;
    position:fixed;
    top:90px; left:0; right:0;
    padding:6px 4px;
    background:#fafafa;
    border-bottom:1px solid #ddd;
    z-index:100;
    overflow-x:auto;
    white-space:nowrap;
  }
  #mainContent { flex-direction:column; margin-top:130px; margin-bottom:120px; height:auto; overflow-y:auto; }
  #chatWindow { flex:1; overflow-y:auto; width:100%; padding-bottom:70px; }
  #chatInput { position:fixed; bottom:40px; left:0; right:0; padding:4px; background:white; z-index:50; width:100%; }
  footer { position:fixed; bottom:0; left:0; right:0; z-index:100; width:100%; height:40px; }
  #userList, #adSidebar { display:none; }
}
</style>
</head>
<body>

<header>
  <h1>–°–ª–∞–≤—è–Ω—Å–∫–∏–π –∫–ª—É–± <img src="emoji_dimitry.png" alt="Dimitry" class="emoji-head"></h1>
</header>

<div id="topBar">
  <button id="backBtn" onclick="window.location.href='index.html'">‚¨Ö Voltar</button>
  <button id="loginBtn">Login com Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <button id="generalBtn" style="display:none;">‚¨Ö Bate-papo geral</button>
  <span id="alertaLogin">‚ö†Ô∏è Fa√ßa login para enviar mensagens.</span>
  <span id="onlineCount">üë• Usu√°rios online: 0</span>
</div>

<div id="mobileUserLine"></div>

<div id="mainContent">
  <div id="userList"></div>
  <div id="chatContainer">
    <div id="chatPartnerName"></div>
    <div id="chatWindow"></div>
    <div id="chatInput">
      <input type="text" id="msgInput" placeholder="Digite sua mensagem..." disabled>
      <button id="sendBtn" disabled>Enviar</button>
    </div>
  </div>
  <div id="adSidebar">Publicidade aqui (Adsense)</div>
</div>

<footer>¬© 2025 –°–ª–∞–≤—è–Ω—Å–∫–∏–π –∫–ª—É–± ‚Äî Aprenda Russo e Portugu√™s com divers√£o!</footer>

<script>
// === CONFIGURA√á√ÉO FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
  authDomain: "dimitry-rusian.firebaseapp.com",
  databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
  projectId: "dimitry-rusian",
  storageBucket: "dimitry-rusian.appspot.com",
  messagingSenderId: "449029666805",
  appId: "1:449029666805:web:feaf575a7b7e6f234a52bc"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const chatWindow=document.getElementById("chatWindow");
const userList=document.getElementById("userList");
const mobileUserLine=document.getElementById("mobileUserLine");
const generalBtn=document.getElementById("generalBtn");
const chatPartnerName=document.getElementById("chatPartnerName");

let currentChat="global";
let privateChatListener=null;
let alertIcons={};
let acceptedChats={};
let hiddenChats={};
let userData={};

// === LOGIN ===
auth.onAuthStateChanged(user=>{
  if(user){
    msgInput.disabled=false;
    sendBtn.disabled=false;
    userData={uid:user.uid,name:user.displayName,photo:user.photoURL};
    db.ref("online/"+user.uid).set({name:user.displayName,photo:user.photoURL});
    db.ref("online/"+user.uid).onDisconnect().remove();
  } else {
    msgInput.disabled=true;
    sendBtn.disabled=true;
    userData={};
  }
});

// === LISTA DE USU√ÅRIOS COM GLOBAL E SELF FIXOS ===
db.ref("online").on("value",snap=>{
  const users=snap.val()||{};
  userList.innerHTML="";
  mobileUserLine.innerHTML="";
  alertIcons={};

  // Global primeiro
  const divGlobal=document.createElement("div");
  divGlobal.className="userItem";
  divGlobal.innerHTML=`<img src="https://cdn-icons-png.flaticon.com/512/1250/1250615.png"><span>üí¨ Global</span>`;
  divGlobal.onclick=()=>startGlobalChat();
  userList.appendChild(divGlobal);
  const mobGlobal=document.createElement("div");
  mobGlobal.className="userItemMobile";
  mobGlobal.innerHTML=`<img src="https://cdn-icons-png.flaticon.com/512/1250/1250615.png" title="Global">`;
  mobGlobal.onclick=()=>startGlobalChat();
  mobileUserLine.appendChild(mobGlobal);

  // Self
  if(userData.uid){
    const selfDiv=document.createElement("div");
    selfDiv.className="userItem";
    selfDiv.innerHTML=`<img src="${userData.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}"><span>${userData.name}</span>`;
    userList.appendChild(selfDiv);
    const selfMob=document.createElement("div");
    selfMob.className="userItemMobile";
    selfMob.innerHTML=`<img src="${userData.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" title="${userData.name}">`;
    mobileUserLine.appendChild(selfMob);
  }

  // Outros usu√°rios
  for(const [uid,u] of Object.entries(users)){
    if(uid===userData.uid) continue;
    const div=document.createElement("div");
    div.className="userItem";
    div.innerHTML=`<img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}"><span>${u.name}</span>`;
    div.onclick=()=>requestPrivateChat(uid,u.name);
    userList.appendChild(div);

    const mob=document.createElement("div");
    mob.className="userItemMobile";
    mob.innerHTML=`<img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" title="${u.name}">`;
    mob.onclick=()=>requestPrivateChat(uid,u.name);
    mobileUserLine.appendChild(mob);

    alertIcons[uid]={desktop:div,mobile:mob};
  }
  startMobileScroll();
});

// === ENVIAR MENSAGEM ===
sendBtn.onclick=sendMessage;
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMessage();});
function sendMessage(){
  if(!userData.uid) return;
  const text=msgInput.value.trim();
  if(!text) return;
  const path=currentChat==="global"?"chatGlobal":"private/"+currentChat;
  db.ref(path).push({user:userData.name,uid:userData.uid,text,timestamp:Date.now()});
  msgInput.value="";
}

// === SHOW MESSAGE ===
function showMessage(msg,room){
  if(hiddenChats[room]) return;
  if(room!=="chatGlobal" && room!==currentChat) return;

  const div=document.createElement("div");
  div.className=msg.uid===userData.uid?"msg userMsg":"msg otherMsg";
  div.textContent=`${msg.user}: ${msg.text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}

// === CHAT GLOBAL ===
db.ref("chatGlobal").on("child_added",snap=>showMessage(snap.val(),"chatGlobal"));
function startGlobalChat(){
  currentChat="global";
  chatPartnerName.textContent="";
  chatWindow.innerHTML="";
  db.ref("chatGlobal").once("value",s=>s.forEach(m=>showMessage(m.val(),"chatGlobal")));
  generalBtn.style.display="none";
}

// === PRIVADO: solicita√ß√£o enviada apenas uma vez ===
function requestPrivateChat(uid,name){
  if(!userData.uid) return alert("Fa√ßa login.");
  if(uid===userData.uid || acceptedChats[uid]) return;

  const reqPath=`privateRequests/${uid}/${userData.uid}`;
  db.ref(reqPath).once("value").then(s=>{
    if(!s.exists()){
      db.ref(reqPath).set({fromName:userData.name});
      alert(`Solicita√ß√£o enviada para ${name}.`);
    } else {
      alert("Solicita√ß√£o j√° enviada, aguardando resposta.");
    }
  });
}

// === RECEBER SOLICITA√á√ÉO ===
auth.onAuthStateChanged(user=>{
  if(!user) return;
  db.ref(`privateRequests/${user.uid}`).on("child_added",snap=>{
    const fromUID=snap.key;
    const fromName=snap.val().fromName;
    if(!acceptedChats[fromUID]){
      if(confirm(`${fromName} quer conversar com voc√™. Aceitar?`)){
        acceptedChats[fromUID]=true;
        const chatId=[user.uid,fromUID].sort().join("_");
        startPrivateChat(chatId,fromName);
      }
    }
    snap.ref.remove();
  });
});

// === INICIAR PRIVADO ===
function startPrivateChat(chatId,partnerName){
  currentChat=chatId;
  hiddenChats[chatId]=false;
  chatPartnerName.textContent=partnerName.split(" ")[0]; // mostrar primeiro nome

  // anima√ß√£o suave
  chatWindow.innerHTML="";
  const container=document.createElement("div");
  container.style.opacity=0;
  container.innerHTML=`<div style='text-align:center;margin:10px;color:#555;'>üí¨ Conversa privada com ${partnerName} 
  <span style="cursor:pointer;color:red;" onclick="hideChat('${chatId}')">[Apagar chat]</span></div>`;
  chatWindow.appendChild(container);
  setTimeout(()=>{container.style.transition="opacity 0.5s"; container.style.opacity=1;},10);

  generalBtn.style.display="inline-block";

  if(privateChatListener) privateChatListener.off();
  privateChatListener=db.ref("private/"+chatId);
  privateChatListener.on("child_added",s=>showMessage(s.val(),chatId));

  // remover alerta visual
  for(const icons of Object.values(alertIcons)){
    icons.desktop.querySelector(".alert-dot")?.remove();
    icons.mobile.querySelector(".alert-dot")?.remove();
  }
}

// === APAGAR CHAT COM ANIMA√á√ÉO ===
function hideChat(chatId){
  if(confirm("Apagar este chat localmente?")){
    hiddenChats[chatId]=true;
    chatWindow.innerHTML="";
    chatPartnerName.textContent="";
    const container=document.createElement("div");
    container.style.opacity=0;
    container.innerHTML=`<div style='text-align:center;margin:10px;color:#555;'>üí¨ Chat apagado. Voc√™ pode retomar clicando no usu√°rio.</div>`;
    chatWindow.appendChild(container);
    setTimeout(()=>{container.style.transition="opacity 0.5s"; container.style.opacity=1;},10);
  }
}

// === SCROLL HORIZONTAL MOBILE ===
let scrollInterval;
function startMobileScroll(){
  clearInterval(scrollInterval);
  const container=mobileUserLine;
  if(!container) return;
  scrollInterval=setInterval(()=>{
    container.scrollLeft+=1;
    if(container.scrollLeft>=container.scrollWidth-container.clientWidth) container.scrollLeft=0;
  },20);
}
</script>
</body>
</html>
