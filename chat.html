<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Dimitri üåç</title>

<!-- Firebase compat SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 0;
}
h2 { margin-top: 20px; color: #333; }

#loginBtn, #logoutBtn {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 10px 15px;
  cursor: pointer;
  border-radius: 5px;
  margin: 0 5px;
}
#loginBtn:hover, #logoutBtn:hover { background: #45a049; }

#chatWindow {
  display: flex;
  flex-direction: column;
  width: 380px;
  height: 520px;
  border: 2px solid #4CAF50;
  border-radius: 12px;
  background: white;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  margin-bottom: 20px;
}
#chatMessages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  font-size: 0.9em;
}
.msg {
  margin: 5px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 80%;
  word-wrap: break-word;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}
.msg img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
}
.userMsg { background: #e0f7e9; align-self: flex-end; }
.otherMsg { background: #fff8dc; align-self: flex-start; }
#chatInput { display: flex; border-top: 1px solid #ddd; }
#chatInput input {
  flex: 1;
  border: none;
  padding: 10px;
  outline: none;
}
#chatInput button {
  background: #4CAF50;
  color: white;
  border: none;
  padding: 10px 15px;
  cursor: pointer;
}
#chatInput button:hover { background: #45a049; }

.time { font-size: 0.7em; color: #555; margin-left: 5px; }
#alertaLogin {
  color: #a00;
  font-size: 0.9em;
  margin-bottom: 10px;
  display: none;
}
#onlineCount {
  font-size: 0.9em;
  color: #333;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<h2>üí¨ Chat Dimitri Global</h2>

<div style="text-align:center; margin-bottom:10px;">
  <button id="loginBtn">Login com Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="onlineCount">üë• Usu√°rios online: 0</div>
<div id="alertaLogin">‚ö†Ô∏è Fa√ßa login para enviar mensagens.</div>

<div id="chatWindow">
  <div id="chatMessages"></div>
  <div id="chatInput">
    <input type="text" id="msgInput" placeholder="Digite sua mensagem..." disabled>
    <button id="sendBtn" disabled>Enviar</button>
  </div>
</div>

<audio id="notifySound" src="https://cdn.pixabay.com/download/audio/2023/02/28/audio_144c8b3b18.mp3?filename=notification-3-126509.mp3"></audio>

<script>
  // === CONFIGURA√á√ÉO FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
    authDomain: "dimitry-rusian.firebaseapp.com",
    databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
    projectId: "dimitry-rusian",
    storageBucket: "dimitry-rusian.appspot.com",
    messagingSenderId: "449029666805",
    appId: "1:449029666805:web:feaf575a7b7e6f234a52bc",
    measurementId: "G-6DLM398X84"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatMessages = document.getElementById("chatMessages");
  const alertaLogin = document.getElementById("alertaLogin");
  const onlineCount = document.getElementById("onlineCount");
  const notifySound = document.getElementById("notifySound");

  // === LOGIN COM GOOGLE ===
  loginBtn.addEventListener("click", () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(() => console.log("‚úÖ Login efetuado"))
      .catch(err => alert("Erro ao logar: " + err.message));
  });

  logoutBtn.addEventListener("click", () => auth.signOut());

  // === GERENCIAR LOGIN ===
  auth.onAuthStateChanged(user => {
    if (user) {
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      alertaLogin.style.display = "none";
      msgInput.disabled = false;
      sendBtn.disabled = false;

      // Adiciona usu√°rio √† lista de online
      const userRef = db.ref("online/" + user.uid);
      userRef.set({ name: user.displayName, photo: user.photoURL });
      userRef.onDisconnect().remove();

    } else {
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      alertaLogin.style.display = "block";
      msgInput.disabled = true;
      sendBtn.disabled = true;
    }
  });

  // === CONTADOR DE USU√ÅRIOS ONLINE ===
  db.ref("online").on("value", snapshot => {
    const count = snapshot.numChildren();
    onlineCount.textContent = `üë• Usu√°rios online: ${count}`;
  });

  // === ENVIAR MENSAGEM ===
  function sendMessage() {
    const msg = msgInput.value.trim();
    const user = auth.currentUser;
    if (!msg || !user) return;

    db.ref('chatGlobal').push({
      user: user.displayName,
      photo: user.photoURL || "",
      text: msg,
      timestamp: Date.now()
    })
    .then(() => msgInput.value = "")
    .catch(err => console.error("Erro ao enviar:", err));
  }

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendMessage();
  });

  // === RECEBER MENSAGENS EM TEMPO REAL ===
  db.ref('chatGlobal').orderByChild('timestamp').on('child_added', snapshot => {
    const msg = snapshot.val();
    const div = document.createElement("div");
    div.classList.add("msg");

    const currentUser = auth.currentUser?.displayName;
    if (msg.user === currentUser) div.classList.add("userMsg");
    else div.classList.add("otherMsg");

    const img = document.createElement("img");
    img.src = msg.photo || "https://cdn-icons-png.flaticon.com/512/847/847969.png";

    const content = document.createElement("div");
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    content.innerHTML = `<strong>${msg.user}:</strong> ${msg.text} <br><span class="time">${time}</span>`;

    div.appendChild(img);
    div.appendChild(content);
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    // üîî Notifica√ß√£o sonora para novas mensagens (de outros usu√°rios)
    if (msg.user !== currentUser) notifySound.play().catch(()=>{});
  });
</script>

</body>
</html>
