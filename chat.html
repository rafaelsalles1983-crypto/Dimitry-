<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>üí¨ Chat ‚Äî Clube Eslavo</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  background: #111;
  color: #fff;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

/* ===== √ÅREA PRINCIPAL ===== */
main {
  flex: 1;
  display: flex;
  overflow: hidden;
}

/* ===== LISTA DE USU√ÅRIOS ===== */
aside {
  width: 240px;
  background: #1c1c1c;
  padding: 10px;
  border-right: 1px solid #333;
  overflow-y: auto;
}

aside h3 {
  text-align: center;
  margin-bottom: 10px;
}

.userItem {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
  position: relative;
}
.userItem:hover {
  background: #333;
}
.userItem img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  margin-right: 8px;
}
.userItem span {
  flex: 1;
}

/* Badge de mensagens n√£o lidas */
.unreadBadge {
  background: #e11d48;
  color: #fff;
  font-size: 0.75em;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: 6px;
}

/* ===== CHAT ===== */
section {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
}

#chatHeader {
  background: #1a1a1a;
  padding: 10px;
  border-bottom: 1px solid #333;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#chatWindow {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.msg {
  margin: 4px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 80%;
}
.userMsg {
  background: #2563eb;
  color: #fff;
  align-self: flex-end;
}
.otherMsg {
  background: #2f2f2f;
  color: #eee;
  align-self: flex-start;
}

/* ===== INPUT ===== */
#chatInput {
  display: flex;
  border-top: 1px solid #333;
  background: #1a1a1a;
}
#msgInput {
  flex: 1;
  padding: 10px;
  border: none;
  outline: none;
  background: transparent;
  color: #fff;
}
#sendBtn {
  background: #2563eb;
  border: none;
  color: #fff;
  padding: 0 20px;
  cursor: pointer;
}

/* ===== FOOTER FIXO NO MOBILE ===== */
footer {
  background: #0a0a0a;
  text-align: center;
  padding: 10px;
  border-top: 1px solid #333;
  font-size: 0.9em;
}
@media (max-width: 768px) {
  footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    left: 0;
  }
}

/* ===== ABAS DE CHAT ===== */
#chatTabs {
  display: flex;
  background: #111;
  border-bottom: 1px solid #333;
}
.tab {
  flex: 1;
  text-align: center;
  padding: 8px;
  cursor: pointer;
  background: #1c1c1c;
}
.tab.active {
  background: #2563eb;
}
</style>
</head>

<body>
<header id="chatHeader">
  <div id="currentPartner">üåç Global</div>
  <div>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Sair</button>
  </div>
</header>

<main>
  <aside>
    <h3>Usu√°rios</h3>
    <div id="userList"></div>
  </aside>

  <section>
    <div id="chatTabs">
      <div class="tab active" id="tabGlobal">üåç Grupo</div>
      <div class="tab" id="tabPrivate">üí¨ Privado</div>
    </div>

    <div id="chatWindow"></div>

    <div id="chatInput">
      <input id="msgInput" placeholder="Digite sua mensagem..." disabled>
      <button id="sendBtn" disabled>Enviar</button>
    </div>
  </section>
</main>

<footer>
  Clube Eslavo ¬© 2025 ‚Äî Conecte-se e pratique idiomas!
</footer>

<script>
/* === CONFIG FIREBASE === */
const firebaseConfig={apiKey:"AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
authDomain:"dimitry-rusian.firebaseapp.com",
databaseURL:"https://dimitry-rusian-default-rtdb.firebaseio.com",
projectId:"dimitry-rusian",storageBucket:"dimitry-rusian.appspot.com",
messagingSenderId:"449029666805",appId:"1:449029666805:web:feaf575a7b7e6f234a52bc"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.database();

/* === ELEMENTOS === */
const loginBtn=document.getElementById("loginBtn"),
logoutBtn=document.getElementById("logoutBtn"),
msgInput=document.getElementById("msgInput"),
sendBtn=document.getElementById("sendBtn"),
chatWindow=document.getElementById("chatWindow"),
userList=document.getElementById("userList"),
currentPartnerEl=document.getElementById("currentPartner"),
tabGlobal=document.getElementById("tabGlobal"),
tabPrivate=document.getElementById("tabPrivate");

let userData={},currentChat="chatGlobal",currentPartnerUID=null,unreadCount={};

/* === LOGIN === */
loginBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(u=>{
 if(u){
  userData={uid:u.uid,name:u.displayName,photo:u.photoURL};
  loginBtn.style.display="none";logoutBtn.style.display="inline-block";
  msgInput.disabled=false;sendBtn.disabled=false;
  db.ref("online/"+u.uid).set({name:u.displayName,photo:u.photoURL});
  db.ref("online/"+u.uid).onDisconnect().remove();
  db.ref("usuariosConectados/"+u.uid).set({name:u.displayName,photo:u.photoURL});
  updateUsers(); startGlobal();
 }else{
  userData={};msgInput.disabled=true;sendBtn.disabled=true;
  loginBtn.style.display="inline-block";logoutBtn.style.display="none";
  startGlobal();
 }
});

/* === LISTA DE USU√ÅRIOS === */
function updateUsers(){
 db.ref("usuariosConectados").on("value",snap=>{
   const allUsers = snap.val()||{};
   db.ref("online").once("value").then(onlineSnap=>{
     const onlineUsers = onlineSnap.val()||{};
     userList.innerHTML="";
     for(const [uid,u] of Object.entries(allUsers)){
       if(uid===userData.uid) continue;
       const isOnline = !!onlineUsers[uid];
       const d=document.createElement("div");
       d.className="userItem";
       d.innerHTML=`<div style="display:flex;align-items:center;">
         <img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}">
         <span>${u.name}${isOnline?' üü¢':' ‚ö™'}</span>
       </div>
       <span id="unread_${uid}" class="unreadBadge" style="display:none;"></span>`;
       d.onclick=()=>{markAsRead(uid);startPrivate(uid,u.name)};
       userList.appendChild(d);
     }
   });
 });
}

/* === CHAT GLOBAL === */
function startGlobal(){
 currentChat="chatGlobal"; currentPartnerUID=null;
 currentPartnerEl.textContent="üåç Grupo Global";
 chatWindow.innerHTML="";
 db.ref("chatGlobal").off();
 db.ref("chatGlobal").on("child_added",snap=>showMsg(snap.val(),"chatGlobal",snap.key));
 tabGlobal.classList.add("active");
 tabPrivate.classList.remove("active");
}

/* === CHAT PRIVADO === */
function startPrivate(uid,name){
 currentPartnerUID=uid; currentChat=[userData.uid,uid].sort().join("_");
 currentPartnerEl.textContent="üí¨ "+name;
 chatWindow.innerHTML="";
 db.ref("private/"+currentChat).off();
 db.ref("private/"+currentChat).on("child_added",snap=>{
   showMsg(snap.val(),currentChat,snap.key);
   if(snap.val().uid!==userData.uid && currentPartnerUID!==uid){
     unreadCount[uid]=(unreadCount[uid]||0)+1;
     updateBadge(uid);
   }
 });
 tabGlobal.classList.remove("active");
 tabPrivate.classList.add("active");
}

/* === ENVIAR MENSAGEM === */
sendBtn.onclick=()=>sendMsg();
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMsg();});
function sendMsg(){
 const text=msgInput.value.trim(); if(!text) return;
 const path=currentChat==="chatGlobal"?"chatGlobal":"private/"+currentChat;
 db.ref(path).push({user:userData.name,uid:userData.uid,text,timestamp:Date.now()});
 msgInput.value="";
}

/* === MOSTRAR MENSAGEM === */
function showMsg(m,room,key){
 if(room!=="chatGlobal" && room!==currentChat) return;
 const d=document.createElement("div");
 d.className=m.uid===userData.uid?"msg userMsg":"msg otherMsg";
 d.textContent=m.text;
 if(m.uid===userData.uid){
   const btn=document.createElement("button");
   btn.textContent="√ó";
   btn.style.marginLeft="6px";
   btn.onclick=()=>{d.remove();};
   d.appendChild(btn);
 }
 chatWindow.appendChild(d);
 chatWindow.scrollTop=chatWindow.scrollHeight;
}

/* === GERENCIAR N√ÉO LIDAS === */
function updateBadge(uid){
 const el=document.getElementById("unread_"+uid);
 if(!el) return;
 const count=unreadCount[uid]||0;
 if(count>0){
   el.textContent=count>9?"9+":count;
   el.style.display="inline-block";
 }else{
   el.style.display="none";
 }
}
function markAsRead(uid){
 unreadCount[uid]=0;
 updateBadge(uid);
}

/* === ABAS === */
tabGlobal.onclick=startGlobal;
</script>
</body>
</html>
