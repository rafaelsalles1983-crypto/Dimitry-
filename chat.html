<script>
const firebaseConfig = {
  apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
  authDomain: "dimitry-rusian.firebaseapp.com",
  databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
  projectId: "dimitry-rusian",
  storageBucket: "dimitry-rusian.appspot.com",
  messagingSenderId: "449029666805",
  appId: "1:449029666805:web:feaf575a7b7e6f234a52bc"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const chatWindow = document.getElementById("chatWindow");
const userList = document.getElementById("userList");
const alertaLogin = document.getElementById("alertaLogin");
const onlineCount = document.getElementById("onlineCount");
const generalBtn = document.getElementById("generalBtn");
const mobileUserLine = document.getElementById("mobileUserLine");
let currentChat = "global";
let privateChatListener = null;

// LOGIN/LOGOUT
loginBtn.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick = () => auth.signOut();

auth.onAuthStateChanged(user => {
  if (user) {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";
    alertaLogin.style.display = "none";
    msgInput.disabled = false;
    sendBtn.disabled = false;
    db.ref("online/" + user.uid).set({ name: user.displayName, photo: user.photoURL });
    db.ref("online/" + user.uid).onDisconnect().remove();
  } else {
    loginBtn.style.display = "inline-block";
    logoutBtn.style.display = "none";
    alertaLogin.style.display = "inline-block";
    msgInput.disabled = true;
    sendBtn.disabled = true;
  }
});

// LISTA DE USUÃRIOS ONLINE
db.ref("online").on("value", snap => {
  const users = snap.val() || {};
  onlineCount.textContent = `ðŸ‘¥ UsuÃ¡rios online: ${Object.keys(users).length}`;
  userList.innerHTML = "";
  mobileUserLine.innerHTML = "";

  for (const [uid, u] of Object.entries(users)) {
    if (!u.name) continue;

    // Desktop
    const userDiv = document.createElement("div");
    userDiv.className = "userItem";
    userDiv.innerHTML = `<img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}"><span>${u.name}</span>`;
    userDiv.onclick = () => requestPrivateChat(uid, u.name);
    userList.appendChild(userDiv);

    // Mobile
    const userMob = document.createElement("div");
    userMob.className = "userItemMobile";
    userMob.innerHTML = `<img src="${u.photo || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" title="${u.name}">`;
    userMob.onclick = () => requestPrivateChat(uid, u.name);
    mobileUserLine.appendChild(userMob);
  }

  startMobileScroll();
});

// ENVIAR MENSAGEM
sendBtn.onclick = sendMessage;
msgInput.addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

function sendMessage() {
  const text = msgInput.value.trim();
  const user = auth.currentUser;
  if (!text || !user) return;

  const path = currentChat === "global" ? "chatGlobal" : "private/" + currentChat;
  db.ref(path).push({
    user: user.displayName,
    uid: user.uid,
    photo: user.photoURL,
    text,
    timestamp: Date.now()
  });
  msgInput.value = "";
}

// EXIBIR MENSAGENS
function showMessage(msg, room) {
  if (room !== "chatGlobal" && room !== currentChat) return;
  const div = document.createElement("div");
  div.className = msg.uid === auth.currentUser?.uid ? "msg userMsg" : "msg otherMsg";
  div.textContent = `${msg.user}: ${msg.text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// CHAT GERAL
db.ref("chatGlobal").on("child_added", snap => showMessage(snap.val(), "chatGlobal"));

// SOLICITAR CHAT PRIVADO
function requestPrivateChat(uid, name) {
  if (!auth.currentUser) return alert("FaÃ§a login para conversar.");
  if (uid === auth.currentUser.uid) return;

  const reqPath = `privateRequests/${uid}`;
  db.ref(reqPath).push({
    from: auth.currentUser.uid,
    fromName: auth.currentUser.displayName
  });
  alert(`SolicitaÃ§Ã£o de conversa enviada para ${name}.`);
}

// RECEBER SOLICITAÃ‡Ã•ES
auth.onAuthStateChanged(user => {
  if (!user) return;
  const reqPath = `privateRequests/${user.uid}`;
  db.ref(reqPath).on("child_added", snap => {
    const data = snap.val();
    const fromUID = data.from;
    const fromName = data.fromName;

    if (confirm(`${fromName} quer conversar com vocÃª em privado. Aceitar?`)) {
      const chatId = [user.uid, fromUID].sort().join("_");
      startPrivateChat(chatId, fromName);
    }
    snap.ref.remove();
  });
});

// INICIAR CHAT PRIVADO
function startPrivateChat(chatId, partnerName) {
  currentChat = chatId;
  chatWindow.innerHTML = `<div style='text-align:center;margin:10px;color:#555;'>ðŸ’¬ Conversa privada com ${partnerName}</div>`;
  generalBtn.style.display = "inline-block";

  if (privateChatListener) privateChatListener.off();
  privateChatListener = db.ref("private/" + chatId);
  privateChatListener.on("child_added", s => showMessage(s.val(), chatId));
}

// VOLTAR AO GERAL
generalBtn.onclick = () => {
  currentChat = "global";
  chatWindow.innerHTML = "";
  db.ref("chatGlobal").once("value", s => s.forEach(m => showMessage(m.val(), "chatGlobal")));
  generalBtn.style.display = "none";
};

// SCROLL INFINITO MOBILE
let scrollInterval;
function startMobileScroll() {
  clearInterval(scrollInterval);
  const container = mobileUserLine;
  if (!container) return;
  scrollInterval = setInterval(() => {
    container.scrollLeft += 1;
    if (container.scrollLeft >= container.scrollWidth - container.clientWidth) {
      container.scrollLeft = 0;
    }
  }, 20);
}
</script>
