<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>чат 🌍</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ===== Seu CSS permanece o mesmo ===== */
:root { --color-bg-light: #f5f5f5; --color-primary: #4CAF50; --color-primary-hover: #45a049; }
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:Arial, sans-serif; background:var(--color-bg-light); transition:background 0.3s, color 0.3s; }
body.dark { background:#121212; color:#eee; }
/* ... resto do CSS permanece inalterado ... */
</style>
</head>
<body>

<header>
  <h1>Славянский клуб <img src="emoji_dimitry.png" alt="Dimitry" class="emoji-head"></h1>
  <div id="langThemeBtns">
    <button id="themeBtn">🌙</button>
    <button id="langBtn">🇷🇺 Рус</button>
  </div>
</header>

<div id="topBar">
  <div class="left">
    <button id="homeBtn">🏠 Início</button>
    <button id="backBtn">⬅️ Voltar</button>
    <button id="loginBtn">Login com Google</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <button id="generalBtn" style="display:none;">💬 Bate-papo Geral</button>
  </div>
  <span id="onlineCount">👥 Usuários online: 0</span>
</div>

<div id="mainContent">
  <div id="userList"></div>
  <div id="chatContainer">
    <div id="chatHeader">
      <h2 id="chatTitle">💬 Bate-papo Geral</h2>
    </div>
    <div id="chatWindow"></div>
    <div id="chatInput">
      <input id="msgInput" type="text" placeholder="Digite sua mensagem..." disabled>
      <button id="sendBtn" disabled>Enviar</button>
    </div>
  </div>
  <div id="adSidebar">Publicidade (Adsense)</div>
</div>

<footer id="footer">© 2025 Славянский клуб — Aprenda Russo e Português</footer>
<div id="notificationContainer"></div>
<audio id="msgSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a8c4e8d5a.mp3?filename=message-pop-alert-23584.mp3" preload="auto"></audio>

<script>
/* ===== TEMAS ===== */
const themeBtn=document.getElementById('themeBtn');
themeBtn.onclick=()=>{document.body.classList.toggle('dark'); themeBtn.textContent=document.body.classList.contains('dark')?'☀️':'🌙';};

/* ===== IDIOMA ===== */
const langBtn=document.getElementById('langBtn');
let currentLang='ru';
const texts={
  ru:{ siteName:"Славянский клуб", homeBtn:"🏠 Главная", backBtn:"⬅️ Назад", loginBtn:"Войти через Google", logoutBtn:"Выйти", chatBtn:"💬 Общий чат", usersOnline:"👥 Пользователи онлайн: ", msgPlaceholder:"Введите сообщение...", sendBtn:"Отправить", footer:"© 2025 Славянский клуб — Учите русский и португальский", chatTitle:"💬 Общий чат" },
  pt:{ siteName:"Славянский клуб", homeBtn:"🏠 Início", backBtn:"⬅️ Voltar", loginBtn:"Login com Google", logoutBtn:"Logout", chatBtn:"💬 Bate-papo Geral", usersOnline:"👥 Usuários online: ", msgPlaceholder:"Digite sua mensagem...", sendBtn:"Enviar", footer:"© 2025 Славянский клуб — Aprenda Russo e Português", chatTitle:"💬 Bate-papo Geral" }
};
function updateTexts(lang){
  document.querySelector('header h1').childNodes[0].nodeValue = texts[lang].siteName + " ";
  document.getElementById('homeBtn').textContent = texts[lang].homeBtn;
  document.getElementById('backBtn').textContent = texts[lang].backBtn;
  document.getElementById('loginBtn').textContent = texts[lang].loginBtn;
  document.getElementById('logoutBtn').textContent = texts[lang].logoutBtn;
  document.getElementById('generalBtn').textContent = texts[lang].chatBtn;
  document.getElementById('onlineCount').textContent = texts[lang].usersOnline + (parseInt(document.getElementById('onlineCount').textContent.replace(/\D/g,''))||0);
  document.getElementById('msgInput').placeholder = texts[lang].msgPlaceholder;
  document.getElementById('sendBtn').textContent = texts[lang].sendBtn;
  document.getElementById('footer').textContent = texts[lang].footer;
  document.getElementById('chatTitle').textContent = texts[lang].chatTitle;
}
langBtn.onclick = ()=>{
  if(currentLang==='ru'){currentLang='pt'; langBtn.textContent='🇧🇷 PT'; document.documentElement.lang='pt-BR';}
  else{currentLang='ru'; langBtn.textContent='🇷🇺 Рус'; document.documentElement.lang='ru';}
  updateTexts(currentLang);
};
updateTexts(currentLang);

/* ===== BOTÕES DE NAVEGAÇÃO ===== */
document.getElementById('homeBtn').onclick = ()=>{ window.location.href = 'index.html'; };
document.getElementById('backBtn').onclick = ()=>{ window.history.back(); };

/* ===== FIREBASE E CHAT ===== */
const firebaseConfig={apiKey:"AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A", authDomain:"dimitry-rusian.firebaseapp.com", databaseURL:"https://dimitry-rusian-default-rtdb.firebaseio.com", projectId:"dimitry-rusian", storageBucket:"dimitry-rusian.appspot.com", messagingSenderId:"449029666805", appId:"1:449029666805:web:feaf575a7b7e6f234a52bc"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.database();

const loginBtnEl=document.getElementById('loginBtn'), logoutBtnEl=document.getElementById('logoutBtn'), generalBtnEl=document.getElementById('generalBtn');
const userList=document.getElementById('userList'), msgInput=document.getElementById('msgInput'), sendBtn=document.getElementById('sendBtn');
const chatWindow=document.getElementById('chatWindow'), chatTitle=document.getElementById('chatTitle'), onlineCount=document.getElementById('onlineCount');
const notificationContainer=document.getElementById('notificationContainer'), msgSound=document.getElementById('msgSound');
let currentUser=null, currentChat='chatGlobal', activeListener=null;

loginBtnEl.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtnEl.onclick=()=>auth.signOut();
generalBtnEl.onclick=openGlobal;

auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    loginBtnEl.style.display='none'; logoutBtnEl.style.display='inline-block'; generalBtnEl.style.display='inline-block';
    msgInput.disabled=false; sendBtn.disabled=false;
    db.ref('users/'+user.uid).set({name:user.displayName,photo:user.photoURL});
    db.ref('online/'+user.uid).set({name:user.displayName});
    db.ref('online/'+user.uid).onDisconnect().remove();
    renderUsers(); openGlobal(); watchPrivateMessages();
  } else { currentUser=null; msgInput.disabled=true; sendBtn.disabled=true; chatWindow.innerHTML=''; }
});

function renderUsers(){
  db.ref('users').on('value',snap=>{
    const all=snap.val()||{};
    db.ref('online').once('value').then(oSnap=>{
      const online=oSnap.val()||{};
      userList.innerHTML=''; let count=0;
      for(const uid in all){
        if(uid===currentUser?.uid) continue;
        const u=all[uid]; const onlineNow=!!online[uid]; if(onlineNow) count++;
        const d=document.createElement('div');
        d.className='userItem';
        d.innerHTML=`<img src="${u.photo}"><span>${onlineNow?'🟢':'⚪'} ${u.name}</span>`;
        d.onclick=()=>openPrivate(uid,u.name);
        userList.appendChild(d);
      }
      onlineCount.textContent = texts[currentLang].usersOnline + count;
    });
  });
}

function openGlobal(){ detach(); currentChat='chatGlobal'; chatTitle.textContent = texts[currentLang].chatTitle; chatWindow.innerHTML=''; const ref=db.ref('chatGlobal').limitToLast(200); activeListener=ref; ref.on('child_added',s=>renderMessage(s.key,s.val())); }

function openPrivate(uid,name){ detach(); const path=['private',[currentUser.uid,uid].sort().join('_')].join('/'); currentChat=path; chatTitle.textContent='👤 '+name; chatWindow.innerHTML=''; const ref=db.ref(path).limitToLast(200); activeListener=ref; ref.on('child_added',s=>renderMessage(s.key,s.val())); removeNotification(uid); }

function detach(){ if(activeListener) activeListener.off(); }
sendBtn.onclick=sendMsg; msgInput.addEventListener('keypress',e=>{if(e.key==='Enter')sendMsg();});
function sendMsg(){ const txt=msgInput.value.trim(); if(!txt||!currentUser)return; db.ref(currentChat).push({uid:currentUser.uid,user:currentUser.displayName,text:txt,timestamp:Date.now()}); msgInput.value=''; }
function renderMessage(key,m){ const div=document.createElement('div'); div.className=m.uid===currentUser?.uid?'msg userMsg':'msg otherMsg'; div.innerHTML=`<strong>${m.user}</strong>: ${m.text}<small>${new Date(m.timestamp).toLocaleTimeString()}</small>`; if(m.uid===currentUser?.uid){ const del=document.createElement('button'); del.className='deleteBtn'; del.textContent='🗑'; del.onclick=()=>db.ref(currentChat+'/'+key).remove(); div.appendChild(del);} chatWindow.appendChild(div); chatWindow.scrollTop=chatWindow.scrollHeight; }

function watchPrivateMessages(){ db.ref('private').on('child_added',chat=>{ const chatId=chat.key; if(!chatId.includes(currentUser.uid)) return; db.ref('private/'+chatId).limitToLast(1).on('child_added',snap=>{ const m=snap.val(); if(m.uid!==currentUser.uid && currentChat!=='private/'+chatId){ const other=chatId.replace(currentUser.uid,'').replace('_',''); showNotification(m.user,m.text,other); msgSound.currentTime=0; msgSound.play(); } }); }); }

function showNotification(user,text,uid){ removeNotification(uid); const n=document.createElement('div'); n.className='notification'; n.dataset.uid=uid; n.innerHTML=`<b>${user}</b>: ${text}<button onclick="removeNotification('${uid}')">✖</button>`; notificationContainer.appendChild(n); }
function removeNotification(uid){ const n=notificationContainer.querySelector(`[data-uid='${uid}']`); if(n) n.remove(); }

</script>
</body>
</html>
