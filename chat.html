<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>чат 🌍</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
/* ... Mantenha seu CSS atual ... */
</style>
</head>
<body>
<header>
  <h1>Славянский клуб <img src="emoji_dimitry.png" alt="Dimitry" class="emoji-head"></h1>
</header>

<div id="topBar">
  <button id="backBtn" onclick="window.location.href='index.html'">⬅ Voltar</button>
  <button id="loginBtn">Login com Google</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
  <button id="generalBtn" style="display:none;">⬅ Bate-papo geral</button>
  <span id="alertaLogin">⚠️ Faça login para enviar mensagens.</span>
  <span id="onlineCount">👥 Usuários online: 0</span>
</div>

<div id="mobileUserLine"></div>

<div id="mainContent">
  <div id="userList"></div>
  <div id="chatContainer">
    <div id="chatWindow"></div>
    <div id="chatInput">
      <input type="text" id="msgInput" placeholder="Digite sua mensagem..." disabled>
      <button id="sendBtn" disabled>Enviar</button>
    </div>
  </div>
  <div id="adSidebar">Publicidade aqui (Adsense)</div>
</div>

<footer>© 2025 Славянский клуб — Aprenda Russo e Português com diversão!</footer>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
  authDomain: "dimitry-rusian.firebaseapp.com",
  databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
  projectId: "dimitry-rusian",
  storageBucket: "dimitry-rusian.appspot.com",
  messagingSenderId: "449029666805",
  appId: "1:449029666805:web:feaf575a7b7e6f234a52bc"
};
firebase.initializeApp(firebaseConfig);

const auth=firebase.auth();
const db=firebase.database();
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const chatWindow=document.getElementById("chatWindow");
const userList=document.getElementById("userList");
const alertaLogin=document.getElementById("alertaLogin");
const onlineCount=document.getElementById("onlineCount");
const generalBtn=document.getElementById("generalBtn");
const mobileUserLine=document.getElementById("mobileUserLine");
let currentChat="global";

// LOGIN/LOGOUT
loginBtn.onclick = ()=> auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
logoutBtn.onclick = ()=> auth.signOut();

auth.onAuthStateChanged(user=>{
  if(user){
    loginBtn.style.display="none";
    logoutBtn.style.display="inline-block";
    alertaLogin.style.display="none";
    msgInput.disabled=false;
    sendBtn.disabled=false;
    db.ref("online/"+user.uid).set({name:user.displayName,photo:user.photoURL});
    db.ref("online/"+user.uid).onDisconnect().remove();
  } else{
    loginBtn.style.display="inline-block";
    logoutBtn.style.display="none";
    alertaLogin.style.display="inline-block";
    msgInput.disabled=true;
    sendBtn.disabled=true;
  }
});

// LISTA DE USUÁRIOS
db.ref("online").on("value", snap=>{
  const users=snap.val()||{};
  onlineCount.textContent=`👥 ${Object.keys(users).length}`;

  userList.innerHTML="";
  mobileUserLine.innerHTML="";
  for(const [uid,u] of Object.entries(users)){
    // Desktop
    const div=document.createElement("div");
    div.className="userItem";
    div.innerHTML=`<img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}"><span>${u.name}</span>`;
    div.onclick=()=>requestPrivateChat(uid,u.name);
    userList.appendChild(div);

    // Mobile
    const divMobile=document.createElement("div");
    divMobile.className="userItemMobile";
    divMobile.innerHTML=`<img src="${u.photo||'https://cdn-icons-png.flaticon.com/512/847/847969.png'}" title="${u.name}">`;
    divMobile.onclick=()=>requestPrivateChat(uid,u.name);
    mobileUserLine.appendChild(divMobile);
  }

  startMobileScroll();
});

// ENVIAR MENSAGEM
sendBtn.onclick = sendMessage;
msgInput.addEventListener("keypress", e=>{if(e.key==="Enter") sendMessage();});
function sendMessage(){
  const text=msgInput.value.trim();
  const user=auth.currentUser;
  if(!text||!user)return;
  const path=currentChat==="global"?"chatGlobal":"private/"+currentChat;
  db.ref(path).push({user:user.displayName,photo:user.photoURL,text,timestamp:Date.now()});
  msgInput.value="";
}

// RECEBER MENSAGENS
db.ref("chatGlobal").on("child_added", snap=>showMessage(snap.val(),"chatGlobal"));
function showMessage(msg,room){
  if(room!=="chatGlobal" && room!==currentChat) return;
  const div=document.createElement("div");
  div.className=msg.user===auth.currentUser?.displayName?"msg userMsg":"msg otherMsg";
  div.textContent=`${msg.user}: ${msg.text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}

// SOLICITAR CHAT PRIVADO
function requestPrivateChat(uid,name){
  if(!auth.currentUser) return alert("Faça login para conversar.");
  if(uid===auth.currentUser.uid) return;

  const reqPath = `privateRequests/${uid}`;
  db.ref(reqPath).push({
    from: auth.currentUser.uid,
    fromName: auth.currentUser.displayName
  });
  alert(`Pedido de conversa privada enviado para ${name}.`);
}

// RECEBER PEDIDO DE CHAT PRIVADO
auth.onAuthStateChanged(user=>{
  if(!user) return;
  const reqPath = `privateRequests/${user.uid}`;
  db.ref(reqPath).on("child_added", snap=>{
    const data = snap.val();
    if(confirm(`${data.fromName} quer conversar com você em privado. Aceitar?`)){
      const chatId = [user.uid, data.from].sort().join("_");
      currentChat = chatId;

      // Atualiza o chatWindow e habilita botões
      chatWindow.innerHTML=`<div style='text-align:center;margin:10px;color:#555;'>💬 Conversa privada com ${data.fromName}</div>`;
      generalBtn.style.display="inline-block";

      // Ambos usuários passam a ouvir o mesmo chat privado
      db.ref("private/"+chatId).off();
      db.ref("private/"+chatId).on("child_added", s=>showMessage(s.val(), chatId));
    }
    snap.ref.remove();
  });
});

// VOLTAR CHAT GERAL
generalBtn.onclick=()=>{
  currentChat="global";
  chatWindow.innerHTML="";
  db.ref("chatGlobal").once("value",s=>{s.forEach(m=>showMessage(m.val(),"chatGlobal"));});
  generalBtn.style.display="none";
};

// SCROLL INFINITO MOBILE
let scrollInterval;
function startMobileScroll(){
  clearInterval(scrollInterval);
  const container = mobileUserLine;
  if(!container) return;
  scrollInterval = setInterval(()=>{
    container.scrollLeft += 1;
    if(container.scrollLeft >= container.scrollWidth - container.clientWidth){
      container.scrollLeft = 0;
    }
  },20);
}
</script>
</body>
</html>
