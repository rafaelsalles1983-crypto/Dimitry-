<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat Dimitry</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --color-primary: #4CAF50;
  --color-bg: #f5f5f5;
}
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--color-bg);
}
header {
  background: white;
  padding: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #ddd;
}
header h1 { color: var(--color-primary); font-size: 1.2em; margin: 0; }

#menuDots {
  cursor: pointer;
  font-size: 1.5em;
  padding: 5px;
}
#menuBox {
  display: none;
  position: absolute;
  right: 10px;
  top: 50px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  z-index: 100;
}
#menuBox button {
  background: none;
  border: none;
  width: 100%;
  padding: 8px 12px;
  text-align: left;
  cursor: pointer;
}
#menuBox button:hover { background: #f0f0f0; }

#userList {
  border-right: 1px solid #ddd;
  width: 200px;
  height: calc(100vh - 50px);
  overflow-y: auto;
  background: #fff;
  float: left;
}
.userItem {
  display: flex;
  align-items: center;
  padding: 8px;
  cursor: pointer;
  position: relative;
}
.userItem:hover { background: #e8f5e9; }
.userItem img {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  margin-right: 8px;
}
.notify-dot {
  position: absolute;
  right: 8px;
  top: 10px;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  animation: blink 1s infinite;
  display: none;
}
@keyframes blink { 50% { opacity: 0; } }

#chatContainer {
  margin-left: 200px;
  height: calc(100vh - 50px);
  display: flex;
  flex-direction: column;
}
#chatHeader {
  background: #fafafa;
  border-bottom: 1px solid #ddd;
  padding: 10px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
#chatWindow {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background: white;
}
.msg {
  margin: 5px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 80%;
  word-wrap: break-word;
}
.userMsg { background: #e0f7e9; align-self: flex-end; text-align: right; }
.otherMsg { background: #fff8dc; align-self: flex-start; text-align: left; }

#chatInput {
  display: flex;
  padding: 8px;
  border-top: 1px solid #ddd;
  background: white;
}
#chatInput input {
  flex: 1;
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 6px;
}
#chatInput button {
  margin-left: 6px;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  cursor: pointer;
}
#toast {
  position: fixed;
  bottom: 60px;
  right: 10px;
  background: #4CAF50;
  color: white;
  padding: 10px 15px;
  border-radius: 5px;
  display: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 200;
}
@media (max-width: 768px) {
  #userList { display: none; }
  #chatContainer { margin-left: 0; }
  #menuBox { top: 60px; right: 5px; }
}
</style>
</head>
<body>

<header>
  <h1>–°–ª–∞–≤—è–Ω—Å–∫–∏–π –∫–ª—É–± üí¨</h1>
  <div id="menuDots">‚ãÆ</div>
  <div id="menuBox">
    <button id="clearChatBtn">üóëÔ∏è Apagar chat</button>
  </div>
</header>

<div id="userList"></div>

<div id="chatContainer">
  <div id="chatHeader"><span id="chatWith">Chat global üåç</span></div>
  <div id="chatWindow"></div>
  <div id="chatInput">
    <input type="text" id="msgInput" placeholder="Digite sua mensagem..." disabled>
    <button id="sendBtn" disabled>Enviar</button>
  </div>
</div>

<div id="toast"></div>

<audio id="msgSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a8c4e8d5a.mp3" preload="auto"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
  authDomain: "dimitry-rusian.firebaseapp.com",
  databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
  projectId: "dimitry-rusian",
  storageBucket: "dimitry-rusian.appspot.com",
  messagingSenderId: "449029666805",
  appId: "1:449029666805:web:feaf575a7b7e6f234a52bc"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const userList = document.getElementById("userList");
const chatWindow = document.getElementById("chatWindow");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const chatWith = document.getElementById("chatWith");
const toast = document.getElementById("toast");
const msgSound = document.getElementById("msgSound");
const menuDots = document.getElementById("menuDots");
const menuBox = document.getElementById("menuBox");
const clearChatBtn = document.getElementById("clearChatBtn");

let currentUser = null;
let currentChat = "global";
let localDeleted = {}; // chats apagados localmente

menuDots.onclick = () => {
  menuBox.style.display = menuBox.style.display === "block" ? "none" : "block";
};

clearChatBtn.onclick = () => {
  localDeleted[currentChat] = true;
  chatWindow.innerHTML = "<p style='text-align:center;color:#777;'>üí¨ Chat apagado localmente.</p>";
  menuBox.style.display = "none";
  localStorage.setItem("deletedChats", JSON.stringify(localDeleted));
};

auth.onAuthStateChanged(user => {
  if(user){
    currentUser = user;
    msgInput.disabled = false;
    sendBtn.disabled = false;
    db.ref("online/"+user.uid).set({name:user.displayName,photo:user.photoURL});
    db.ref("online/"+user.uid).onDisconnect().remove();
  }
});

db.ref("online").on("value",snap=>{
  userList.innerHTML="";
  const users = snap.val() || {};
  for(const [uid,u] of Object.entries(users)){
    if(uid===currentUser?.uid) continue;
    const div=document.createElement("div");
    div.className="userItem";
    div.innerHTML=`<img src="${u.photo||''}"><span>${u.name}</span><div class='notify-dot'></div>`;
    div.onclick=()=>openPrivateChat(uid,u.name);
    div.dataset.uid=uid;
    userList.appendChild(div);
  }
});

sendBtn.onclick=sendMessage;
msgInput.onkeypress=e=>{if(e.key==="Enter")sendMessage();};

function sendMessage(){
  const text=msgInput.value.trim();
  if(!text||!currentUser)return;
  const path=currentChat==="global"?"chatGlobal":"private/"+currentChat;
  db.ref(path).push({
    uid:currentUser.uid,
    user:currentUser.displayName,
    text,
    timestamp:Date.now()
  });
  msgInput.value="";
}

db.ref("chatGlobal").on("child_added",snap=>{
  const msg=snap.val();
  if(localDeleted["global"]) return;
  showMessage(msg,"global");
  if(msg.uid!==currentUser?.uid && currentChat!=="global"){
    showToast("üåç Nova mensagem no chat global");
    msgSound.play();
  }
});

function openPrivateChat(uid,name){
  if(!currentUser) return alert("Fa√ßa login para conversar");
  const chatId=[uid,currentUser.uid].sort().join("_");
  currentChat=chatId;
  chatWith.textContent="üí¨ "+name;
  chatWindow.innerHTML="";
  if(localDeleted[chatId]) {
    chatWindow.innerHTML="<p style='text-align:center;color:#777;'>üí¨ Chat apagado localmente.</p>";
    return;
  }
  db.ref("private/"+chatId).once("value",s=>s.forEach(m=>showMessage(m.val(),chatId)));
  listenPrivate(chatId,uid);
}

function listenPrivate(chatId,otherUid){
  db.ref("private/"+chatId).off();
  db.ref("private/"+chatId).on("child_added",snap=>{
    const msg=snap.val();
    if(localDeleted[chatId]) return;
    showMessage(msg,chatId);
    if(msg.uid!==currentUser.uid && currentChat!==chatId){
      showToast("üí¨ Nova mensagem de "+msg.user);
      msgSound.play();
      showNotifyDot(otherUid,true);
    }
    if(msg.uid!==currentUser.uid && currentChat===chatId){
      showNotifyDot(otherUid,false);
    }
  });
}

function showMessage(msg,room){
  if(room!==currentChat)return;
  const div=document.createElement("div");
  div.className="msg "+(msg.uid===currentUser?.uid?"userMsg":"otherMsg");
  div.textContent=`${msg.user}: ${msg.text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}

function showToast(text){
  toast.textContent=text;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
}

function showNotifyDot(uid,show){
  const userDiv=[...document.querySelectorAll(".userItem")].find(el=>el.dataset.uid===uid);
  if(userDiv){
    const dot=userDiv.querySelector(".notify-dot");
    if(dot) dot.style.display=show?"block":"none";
  }
}

// restaura chats apagados localmente
const stored = localStorage.getItem("deletedChats");
if(stored) localDeleted = JSON.parse(stored);
</script>
</body>
</html>
