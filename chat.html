<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–°–ª–∞–≤—è–Ω—Å–∫–∏–π –∫–ª—É–± üí¨</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root {
  --primary: #4CAF50;
  --bg: #f5f5f5;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
}

/* ===== Header ===== */
header {
  background: white;
  color: var(--primary);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  border-bottom: 1px solid #ddd;
  position: fixed;
  width: 100%;
  top: 0;
  z-index: 100;
}
header h1 {
  margin: 0;
  font-size: 1.2em;
  display: flex;
  align-items: center;
  gap: 6px;
}
#menuDots {
  cursor: pointer;
  font-size: 1.5em;
  padding: 6px;
}

/* ===== Menu oculto ===== */
#menuBox {
  display: none;
  position: fixed;
  right: 10px;
  top: 50px;
  background: white;
  border: 1px solid #ccc;
  border-radius: 8px;
  z-index: 200;
}
#menuBox button {
  border: none;
  background: none;
  padding: 10px;
  width: 100%;
  text-align: left;
  cursor: pointer;
}
#menuBox button:hover {
  background: #f0f0f0;
}

/* ===== Barra superior ===== */
#topBar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fafafa;
  border-bottom: 1px solid #ddd;
  margin-top: 50px;
  padding: 6px 10px;
}
#globalBtn {
  background: white;
  border: 1px solid var(--primary);
  color: var(--primary);
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  position: relative;
}
#globalBtn .notify-dot {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  animation: blink 1s infinite;
  display: none;
}

/* ===== Users list ===== */
#userList {
  width: 220px;
  background: white;
  border-right: 1px solid #ddd;
  height: calc(100vh - 100px);
  overflow-y: auto;
  float: left;
}
.userItem {
  display: flex;
  align-items: center;
  padding: 8px;
  cursor: pointer;
  position: relative;
}
.userItem:hover { background: #e8f5e9; }
.userItem img {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  margin-right: 8px;
}
.notify-dot {
  position: absolute;
  right: 8px;
  top: 14px;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  animation: blink 1s infinite;
  display: none;
}
@keyframes blink { 50% { opacity: 0; } }

/* ===== Chat ===== */
#chatContainer {
  margin-left: 220px;
  display: flex;
  flex-direction: column;
  height: calc(100vh - 100px);
}
#chatHeader {
  background: #fafafa;
  border-bottom: 1px solid #ddd;
  padding: 10px;
  font-weight: bold;
}
#chatWindow {
  flex: 1;
  overflow-y: auto;
  background: white;
  padding: 10px;
}
.msg {
  margin: 5px 0;
  padding: 8px;
  border-radius: 8px;
  max-width: 80%;
  word-wrap: break-word;
}
.userMsg { background: #e0f7e9; align-self: flex-end; text-align: right; }
.otherMsg { background: #fff8dc; align-self: flex-start; text-align: left; }

#chatInput {
  display: flex;
  padding: 8px;
  border-top: 1px solid #ddd;
  background: white;
}
#chatInput input {
  flex: 1;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 8px;
}
#chatInput button {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  margin-left: 6px;
  cursor: pointer;
}

/* ===== Mobile users bar ===== */
#mobileUsers {
  display: none;
  overflow-x: auto;
  white-space: nowrap;
  background: #fafafa;
  border-bottom: 1px solid #ddd;
}
.userIcon {
  display: inline-block;
  position: relative;
  margin: 5px;
  cursor: pointer;
}
.userIcon img {
  width: 50px;
  height: 50px;
  border-radius: 50%;
}
.userIcon .notify-dot {
  position: absolute;
  top: 2px;
  right: 4px;
  width: 10px;
  height: 10px;
  background: red;
  border-radius: 50%;
  animation: blink 1s infinite;
  display: none;
}

/* ===== Toast ===== */
#toast {
  position: fixed;
  bottom: 60px;
  right: 10px;
  background: var(--primary);
  color: white;
  padding: 10px 15px;
  border-radius: 5px;
  display: none;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
  #userList { display: none; }
  #mobileUsers { display: flex; }
  #chatContainer { margin-left: 0; height: calc(100vh - 180px); }
}
</style>
</head>
<body>

<header>
  <h1>–°–ª–∞–≤—è–Ω—Å–∫–∏–π –∫–ª—É–± üí¨</h1>
  <div id="menuDots">‚ãÆ</div>
  <div id="menuBox"><button id="clearChatBtn">üóëÔ∏è Apagar chat</button></div>
</header>

<div id="topBar">
  <button id="globalBtn">üåç Chat Global <div class="notify-dot"></div></button>
  <span id="onlineCount">üë• 0 online</span>
</div>

<div id="mobileUsers"></div>
<div id="userList"></div>

<div id="chatContainer">
  <div id="chatHeader">Chat Global üåç</div>
  <div id="chatWindow"></div>
  <div id="chatInput">
    <input type="text" id="msgInput" placeholder="Digite sua mensagem..." disabled>
    <button id="sendBtn" disabled>Enviar</button>
  </div>
</div>

<div id="toast"></div>
<audio id="msgSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2a8c4e8d5a.mp3" preload="auto"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCYJCgfil5HKrCWtB14zwdicDaEcldHU6A",
  authDomain: "dimitry-rusian.firebaseapp.com",
  databaseURL: "https://dimitry-rusian-default-rtdb.firebaseio.com",
  projectId: "dimitry-rusian",
  storageBucket: "dimitry-rusian.appspot.com",
  messagingSenderId: "449029666805",
  appId: "1:449029666805:web:feaf575a7b7e6f234a52bc"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const chatWindow=document.getElementById("chatWindow");
const chatHeader=document.getElementById("chatHeader");
const globalBtn=document.getElementById("globalBtn");
const globalDot=globalBtn.querySelector(".notify-dot");
const userList=document.getElementById("userList");
const mobileUsers=document.getElementById("mobileUsers");
const toast=document.getElementById("toast");
const msgSound=document.getElementById("msgSound");
const menuDots=document.getElementById("menuDots");
const menuBox=document.getElementById("menuBox");
const clearChatBtn=document.getElementById("clearChatBtn");
const onlineCount=document.getElementById("onlineCount");

let currentUser=null;
let currentChat="global";
let deletedChats=JSON.parse(localStorage.getItem("deletedChats")||"{}");

// Menu ‚ãÆ
menuDots.onclick=()=>{menuBox.style.display=menuBox.style.display==="block"?"none":"block";};
clearChatBtn.onclick=()=>{
  deletedChats[currentChat]=true;
  localStorage.setItem("deletedChats",JSON.stringify(deletedChats));
  chatWindow.innerHTML="<p style='text-align:center;color:#777;'>üí¨ Chat apagado localmente.</p>";
  menuBox.style.display="none";
};

// Login autom√°tico Google (tempor√°rio)
auth.signInAnonymously();

// Estado online
auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    msgInput.disabled=false;
    sendBtn.disabled=false;
    db.ref("online/"+user.uid).set({name:"Usu√°rio "+user.uid.slice(-4),photo:"https://cdn-icons-png.flaticon.com/512/847/847969.png"});
    db.ref("online/"+user.uid).onDisconnect().remove();
  }
});

// Lista de usu√°rios
db.ref("online").on("value",snap=>{
  userList.innerHTML=""; mobileUsers.innerHTML="";
  const users=snap.val()||{};
  const total=Object.keys(users).length;
  onlineCount.textContent=`üë• ${total} online`;
  for(const [uid,u] of Object.entries(users)){
    if(uid===currentUser?.uid) continue;
    const userDiv=document.createElement("div");
    userDiv.className="userItem";
    userDiv.innerHTML=`<img src="${u.photo}"><span>${u.name}</span><div class='notify-dot'></div>`;
    userDiv.dataset.uid=uid;
    userDiv.onclick=()=>openPrivate(uid,u.name);
    userList.appendChild(userDiv);

    const mob=document.createElement("div");
    mob.className="userIcon";
    mob.innerHTML=`<img src="${u.photo}" title="${u.name}"><div class='notify-dot'></div>`;
    mob.dataset.uid=uid;
    mob.onclick=()=>openPrivate(uid,u.name);
    mobileUsers.appendChild(mob);
  }
});

// Chat global
db.ref("chatGlobal").on("child_added",snap=>{
  const msg=snap.val();
  if(deletedChats["global"]) return;
  showMsg(msg,"global");
  if(msg.uid!==currentUser?.uid && currentChat!=="global"){
    globalDot.style.display="block";
    toastMsg("üåç Nova mensagem no global");
    msgSound.play();
  }
});

globalBtn.onclick=()=>{
  globalDot.style.display="none";
  currentChat="global";
  chatHeader.textContent="Chat Global üåç";
  loadMessages("chatGlobal","global");
};

sendBtn.onclick=sendMsg;
msgInput.onkeypress=e=>{if(e.key==="Enter")sendMsg();};

function sendMsg(){
  const text=msgInput.value.trim();
  if(!text||!currentUser)return;
  const path=currentChat==="global"?"chatGlobal":"private/"+currentChat;
  db.ref(path).push({uid:currentUser.uid,text,user:"Voc√™",timestamp:Date.now()});
  msgInput.value="";
}

function openPrivate(uid,name){
  const chatId=[uid,currentUser.uid].sort().join("_");
  currentChat=chatId;
  chatHeader.textContent="üí¨ "+name;
  chatWindow.innerHTML="";
  loadMessages("private/"+chatId,chatId);
  listenPrivate(chatId,uid);
  hideDot(uid);
}

function loadMessages(path,id){
  chatWindow.innerHTML="";
  if(deletedChats[id]){
    chatWindow.innerHTML="<p style='text-align:center;color:#777;'>üí¨ Chat apagado localmente.</p>";
    return;
  }
  db.ref(path).once("value",snap=>snap.forEach(s=>showMsg(s.val(),id)));
}

function listenPrivate(chatId,otherUid){
  db.ref("private/"+chatId).off();
  db.ref("private/"+chatId).on("child_added",snap=>{
    const msg=snap.val();
    if(deletedChats[chatId]) return;
    showMsg(msg,chatId);
    if(msg.uid!==currentUser.uid && currentChat!==chatId){
      toastMsg("üí¨ Nova mensagem recebida!");
      showDot(otherUid);
      msgSound.play();
    }
  });
}

function showMsg(msg,id){
  if(id!==currentChat)return;
  const div=document.createElement("div");
  div.className="msg "+(msg.uid===currentUser?.uid?"userMsg":"otherMsg");
  div.textContent=`${msg.user}: ${msg.text}`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop=chatWindow.scrollHeight;
}

function toastMsg(txt){
  toast.textContent=txt;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
}

function showDot(uid){
  document.querySelectorAll(`[data-uid='${uid}'] .notify-dot`).forEach(d=>d.style.display="block");
}
function hideDot(uid){
  document.querySelectorAll(`[data-uid='${uid}'] .notify-dot`).forEach(d=>d.style.display="none");
}
</script>
</body>
</html>
